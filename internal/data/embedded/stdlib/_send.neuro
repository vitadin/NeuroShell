%% Description: Seamless send implementation leveraging variable service and auto-client creation
%% Usage: \send[include_thinking=false] Hello, how are you?
%% Options:
%%   include_thinking - Include thinking blocks in session message (default: false)
%% Assumes user has activated a model first (seamless "Model â†’ Chat" workflow)
%% 
%% Workflow:
%% 1. Ensure active session (create if needed)
%% 2. Add user message to session  
%% 3. Ensure active model (create default if needed)
%% 4. Get client (leverages auto-creation from model commands)
%% 5. Make LLM call
%% 6. Add assistant response and display

%% Step 1: Ensure active session - create if session-activate returns empty
\silent \session-activate
\silent \if-not[condition="${_session_id}"] \session-new

%% Step 2: Add user message to session
\silent \session-add-usermsg[session=${_session_id}] ${_1}

%% Step 3: Ensure active model - create default if no active model
\silent \get[#active_model_name]
\silent \if-not[condition="${#active_model_name}"] \model-new[catalog_id="O4MC"] default_model

%% Step 4: Ensure active client is available 
%% Since we have an active model, we should have an active client ID available
%% If not, fall back to the most recently created client
\silent \get[#active_client_id]
\silent \if-not[condition="${#active_client_id}"] \set[#active_client_id="${_client_id}"]
\silent \if-not[condition="${#active_client_id}"] \echo "Warning: No active client ID found, model may not be properly activated"

%% Step 5: Make LLM call using all components (not silent to show thinking display)
\llm-call[client_id=${#active_client_id}, session_id=${_session_id}]

%% Step 6: Add assistant response to session and display content
%% Determine what content to add to session based on include_thinking option
\if[condition="${include_thinking}"] \silent \set[session_content="${#llm_thinking_blocks_rendered}${#llm_text_content}"]
\if-not[condition="${include_thinking}"] \silent \set[session_content="${#llm_text_content}"]

%% Add content to session if we have any content
\if[condition="${session_content}"] \silent \session-add-assistantmsg[session=${_session_id}] ${session_content}

%% Display thinking blocks first if present (using render command for proper styling)
\if[condition="${#llm_thinking_blocks_rendered}"] \render ${#llm_thinking_blocks_rendered}

%% Render the clean text content with markdown if we have content
\if[condition="${#llm_text_content}"] \render-markdown ${#llm_text_content}

%% Display errors at the end if present (ensures errors are visible after content)
\if[condition="${#llm_error_code}"] \render[style=error] Error (${#llm_error_code}): ${#llm_error_message}
