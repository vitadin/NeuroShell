# Test send command with different model configurations
# This test verifies that the send command works with various model configurations
Setting _echo_command = true
%%> "# Start with a clean state"
# Start with a clean state
%%> "\\session-list"
No sessions found.
%%> "# Create a new session for testing"
# Create a new session for testing
%%> "\\session-new[system=\"You are a model configuration test assistant\"] model_test_session"
Created session 'model_test_session' (ID: 00000001)
%%> "# Test 1: Use default model configuration"
# Test 1: Use default model configuration
%%> "\\send Test message with default model configuration"
%%> "\\session-activate"
Active session: model_test_session (ID: 00000001)
%%> "\\set[session_id=\"${_session_id}\"]"
Setting session_id = 00000001-0000-4000-8000-000000000001
%%> "\\set[empty_check=\"${session_id}\"]"
Setting empty_check = 00000001-0000-4000-8000-000000000001
%%> "\\set[need_new=\"yes\"]"
Setting need_new = yes
%%> "\\if[condition=\"${empty_check}\"] \\set[need_new=\"\"]"
%%> "\\set[need_new=\"\"]"
Setting need_new = 
%%> "\\if[condition=\"${need_new}\"] \\session-new"
%%> "\\if[condition=\"${need_new}\"] \\set[session_id=\"${#session_id}\"]"
%%> "\\session-add-usermsg[session=${session_id}] ${_1}"
Added user message to session '00000001-0000-4000-8000-000000000001'
%%> "\\llm-client-get[provider=openai]"
LLM client ready: openai:b10394de (configured: true)
%%> "\\set[client_id=\"${_client_id}\"]"
Setting client_id = openai:b10394de
%%> "\\get[#active_model_name]"
#active_model_name = 
%%> "\\set[has_model=\"${#active_model_name}\"]"
Setting has_model = 
%%> "\\set[need_model=\"yes\"]"
Setting need_model = yes
%%> "\\if[condition=\"${has_model}\"] \\set[need_model=\"\"]"
%%> "\\if[condition=\"${need_model}\"] \\model-new[catalog_id=O4M] default_model"
%%> "\\model-new[catalog_id=O4M] default_model"
Created model 'default_model' (ID: 00000003, Provider: openai, Base: o4-mini)
%%> "\\if[condition=\"${need_model}\"] \\model-activate default_model"
%%> "\\model-activate default_model"
Activated model 'default_model' (ID: 00000003, Provider: openai, Base: o4-mini)
%%> "\\llm-call[client_id=${client_id}, session_id=${session_id}]"
This is a mocking reply (received 1 messages, last: Test message with default model configuration)
%%> "\\session-add-assistantmsg[session=${session_id}] ${_output}"
Added assistant message to session '00000001-0000-4000-8000-000000000001'
%%> "\\set[1=\"${_output}\"]"
Setting 1 = This is a mocking reply (received 1 messages, last: Test message with default model configuration)
%%> "\\render-markdown ${_output}"
  This is a mocking reply (received 1 messages, last: Test message with       
  default model configuration)                                                
%%> "# Check what model was used"
# Check what model was used
%%> "\\get[#active_model_name]"
#active_model_name = default_model
%%> "\\get[#active_model_provider]"
#active_model_provider = openai
%%> "# Test 2: Create and activate a specific model configuration using catalog_id"
# Test 2: Create and activate a specific model configuration using catalog_id
%%> "\\model-new[catalog_id=O4M, temperature=0.7, max_tokens=150] test_model"
Created model 'test_model' (ID: 00000005, Provider: openai, Base: o4-mini)
%%> "\\model-activate test_model"
Activated model 'test_model' (ID: 00000005, Provider: openai, Base: o4-mini)
%%> "# Send message with the specific model configuration"
# Send message with the specific model configuration
%%> "\\send Test message with custom O4-mini model"
%%> "\\session-activate"
Active session: model_test_session (ID: 00000001)
%%> "\\set[session_id=\"${_session_id}\"]"
Setting session_id = 00000001-0000-4000-8000-000000000001
%%> "\\set[empty_check=\"${session_id}\"]"
Setting empty_check = 00000001-0000-4000-8000-000000000001
%%> "\\set[need_new=\"yes\"]"
Setting need_new = yes
%%> "\\if[condition=\"${empty_check}\"] \\set[need_new=\"\"]"
%%> "\\set[need_new=\"\"]"
Setting need_new = 
%%> "\\if[condition=\"${need_new}\"] \\session-new"
%%> "\\if[condition=\"${need_new}\"] \\set[session_id=\"${#session_id}\"]"
%%> "\\session-add-usermsg[session=${session_id}] ${_1}"
Added user message to session '00000001-0000-4000-8000-000000000001'
%%> "\\llm-client-get[provider=openai]"
LLM client ready: openai:b10394de (configured: true)
%%> "\\set[client_id=\"${_client_id}\"]"
Setting client_id = openai:b10394de
%%> "\\get[#active_model_name]"
#active_model_name = test_model
%%> "\\set[has_model=\"${#active_model_name}\"]"
Setting has_model = test_model
%%> "\\set[need_model=\"yes\"]"
Setting need_model = yes
%%> "\\if[condition=\"${has_model}\"] \\set[need_model=\"\"]"
%%> "\\set[need_model=\"\"]"
Setting need_model = 
%%> "\\if[condition=\"${need_model}\"] \\model-new[catalog_id=O4M] default_model"
%%> "\\if[condition=\"${need_model}\"] \\model-activate default_model"
%%> "\\llm-call[client_id=${client_id}, session_id=${session_id}]"
This is a mocking reply (received 3 messages, last: Test message with custom O4-mini model)
%%> "\\session-add-assistantmsg[session=${session_id}] ${_output}"
Added assistant message to session '00000001-0000-4000-8000-000000000001'
%%> "\\set[1=\"${_output}\"]"
Setting 1 = This is a mocking reply (received 3 messages, last: Test message with custom O4-mini model)
%%> "\\render-markdown ${_output}"
  This is a mocking reply (received 3 messages, last: Test message with custom
  O4-mini model)                                                              
%%> "# Check what model was used"
# Check what model was used
%%> "\\get[#active_model_name]"
#active_model_name = test_model
%%> "\\get[#active_model_provider]"
#active_model_provider = openai
%%> "\\get[#active_model_temperature]"
#active_model_temperature = 
%%> "\\get[#active_model_max_tokens]"
#active_model_max_tokens = 
%%> "# Test 3: Switch to a different model configuration"
# Test 3: Switch to a different model configuration
%%> "\\model-new[catalog_id=CS4, temperature=0.2, max_tokens=100] strict_model"
Created model 'strict_model' (ID: 00000008, Provider: anthropic, Base: claude-sonnet-4-20250514)
%%> "\\model-activate strict_model"
Activated model 'strict_model' (ID: 00000008, Provider: anthropic, Base: claude-sonnet-4-20250514)
%%> "# Send message with the different model configuration"
# Send message with the different model configuration
%%> "\\send Test message with strict Claude Sonnet 4 model configuration"
%%> "\\session-activate"
Active session: model_test_session (ID: 00000001)
%%> "\\set[session_id=\"${_session_id}\"]"
Setting session_id = 00000001-0000-4000-8000-000000000001
%%> "\\set[empty_check=\"${session_id}\"]"
Setting empty_check = 00000001-0000-4000-8000-000000000001
%%> "\\set[need_new=\"yes\"]"
Setting need_new = yes
%%> "\\if[condition=\"${empty_check}\"] \\set[need_new=\"\"]"
%%> "\\set[need_new=\"\"]"
Setting need_new = 
%%> "\\if[condition=\"${need_new}\"] \\session-new"
%%> "\\if[condition=\"${need_new}\"] \\set[session_id=\"${#session_id}\"]"
%%> "\\session-add-usermsg[session=${session_id}] ${_1}"
Added user message to session '00000001-0000-4000-8000-000000000001'
%%> "\\llm-client-get[provider=openai]"
LLM client ready: openai:b10394de (configured: true)
%%> "\\set[client_id=\"${_client_id}\"]"
Setting client_id = openai:b10394de
%%> "\\get[#active_model_name]"
#active_model_name = strict_model
%%> "\\set[has_model=\"${#active_model_name}\"]"
Setting has_model = strict_model
%%> "\\set[need_model=\"yes\"]"
Setting need_model = yes
%%> "\\if[condition=\"${has_model}\"] \\set[need_model=\"\"]"
%%> "\\set[need_model=\"\"]"
Setting need_model = 
%%> "\\if[condition=\"${need_model}\"] \\model-new[catalog_id=O4M] default_model"
%%> "\\if[condition=\"${need_model}\"] \\model-activate default_model"
%%> "\\llm-call[client_id=${client_id}, session_id=${session_id}]"
This is a mocking reply (received 5 messages, last: Test message with strict Claude Sonnet 4 model configuration)
%%> "\\session-add-assistantmsg[session=${session_id}] ${_output}"
Added assistant message to session '00000001-0000-4000-8000-000000000001'
%%> "\\set[1=\"${_output}\"]"
Setting 1 = This is a mocking reply (received 5 messages, last: Test message with strict Claude Sonnet 4 model configuration)
%%> "\\render-markdown ${_output}"
  This is a mocking reply (received 5 messages, last: Test message with strict
  Claude Sonnet 4 model configuration)                                        
%%> "# Check what model was used"
# Check what model was used
%%> "\\get[#active_model_name]"
#active_model_name = strict_model
%%> "\\get[#active_model_provider]"
#active_model_provider = anthropic
%%> "\\get[#active_model_temperature]"
#active_model_temperature = 
%%> "\\get[#active_model_max_tokens]"
#active_model_max_tokens = 
%%> "# Test 4: Verify model configuration persists across send calls"
# Test 4: Verify model configuration persists across send calls
%%> "\\send Second message to verify model persistence"
%%> "\\session-activate"
Active session: model_test_session (ID: 00000001)
%%> "\\set[session_id=\"${_session_id}\"]"
Setting session_id = 00000001-0000-4000-8000-000000000001
%%> "\\set[empty_check=\"${session_id}\"]"
Setting empty_check = 00000001-0000-4000-8000-000000000001
%%> "\\set[need_new=\"yes\"]"
Setting need_new = yes
%%> "\\if[condition=\"${empty_check}\"] \\set[need_new=\"\"]"
%%> "\\set[need_new=\"\"]"
Setting need_new = 
%%> "\\if[condition=\"${need_new}\"] \\session-new"
%%> "\\if[condition=\"${need_new}\"] \\set[session_id=\"${#session_id}\"]"
%%> "\\session-add-usermsg[session=${session_id}] ${_1}"
Added user message to session '00000001-0000-4000-8000-000000000001'
%%> "\\llm-client-get[provider=openai]"
LLM client ready: openai:b10394de (configured: true)
%%> "\\set[client_id=\"${_client_id}\"]"
Setting client_id = openai:b10394de
%%> "\\get[#active_model_name]"
#active_model_name = strict_model
%%> "\\set[has_model=\"${#active_model_name}\"]"
Setting has_model = strict_model
%%> "\\set[need_model=\"yes\"]"
Setting need_model = yes
%%> "\\if[condition=\"${has_model}\"] \\set[need_model=\"\"]"
%%> "\\set[need_model=\"\"]"
Setting need_model = 
%%> "\\if[condition=\"${need_model}\"] \\model-new[catalog_id=O4M] default_model"
%%> "\\if[condition=\"${need_model}\"] \\model-activate default_model"
%%> "\\llm-call[client_id=${client_id}, session_id=${session_id}]"
This is a mocking reply (received 7 messages, last: Second message to verify model persistence)
%%> "\\session-add-assistantmsg[session=${session_id}] ${_output}"
Added assistant message to session '00000001-0000-4000-8000-000000000001'
%%> "\\set[1=\"${_output}\"]"
Setting 1 = This is a mocking reply (received 7 messages, last: Second message to verify model persistence)
%%> "\\render-markdown ${_output}"
  This is a mocking reply (received 7 messages, last: Second message to verify
  model persistence)                                                          
%%> "# Check that model configuration is still active"
# Check that model configuration is still active
%%> "\\get[#active_model_name]"
#active_model_name = strict_model
%%> "# Clean up"
# Clean up
%%> "\\session-delete model_test_session"
Deleted session 'model_test_session' (ID: 00000001)
%%> "\\model-delete test_model"
Deleted model 'test_model' (ID: 00000005, Provider: openai, Base: o4-mini)
%%> "\\model-delete strict_model"
Deleted model 'strict_model' (ID: 00000008, Provider: anthropic, Base: claude-sonnet-4-20250514)