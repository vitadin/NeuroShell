%% Critical test: Variable interpolation with \if command
%% This test verifies that the state machine properly interpolates variables 
%% BEFORE the \if command executes (our architecture fix)
\set[_echo_command="true"]

%% Setup test variables
\set[true_flag="true"]
\set[false_flag="false"] 
\set[yes_flag="yes"]
\set[no_flag="no"]
\set[empty_flag=""]
\set[number_one="1"]
\set[number_zero="0"]

%% Test basic variable interpolation in conditions
\if[condition=${true_flag}] \echo "Variable true_flag worked"
\if[condition=${false_flag}] \echo "This should not appear - false_flag"

%% Test different truthy variable values
\if[condition=${yes_flag}] \echo "Variable yes_flag is truthy"
\if[condition=${number_one}] \echo "Variable number_one is truthy"

%% Test different falsy variable values  
\if[condition=${no_flag}] \echo "This should not appear - no_flag"
\if[condition=${number_zero}] \echo "This should not appear - number_zero" 
\if[condition=${empty_flag}] \echo "This should not appear - empty_flag"

%% Test system variable interpolation
\if[condition=${#test_mode}] \echo "System variable test_mode is true"

%% Test user info variable interpolation (if available)
\set[user_check="${@user}"]
\if[condition=${user_check}] \echo "User variable is truthy: ${@user}"

%% Test nested variable interpolation 
\set[flag_name="true_flag"]
\set[nested_condition="${${flag_name}}"]
\get[nested_condition]
\if[condition=${nested_condition}] \echo "Nested interpolation worked"

%% Test variable interpolation in the command part too
\set[command_name="echo"]
\set[message="Variable interpolation in command"]
\if[condition=true] \${command_name} "${message}"

%% Test complex interpolation scenario
\set[prefix="user"]
\set[suffix="flag"] 
\set[user_flag="enabled"]
\if[condition=${${prefix}_${suffix}}] \echo "Complex interpolation: ${prefix}_${suffix} = ${user_flag}"

%% Test that variables are expanded exactly once (no double expansion)
\set[literal_pattern="\${not_a_var}"]
\get[literal_pattern]
\if[condition=true] \echo "Pattern not re-expanded: ${literal_pattern}"

%% Verify interpolation happens before condition evaluation
\set[test_result="working"]
\if[condition=${test_result}] \set[interpolation_success="true"]
\get[interpolation_success]