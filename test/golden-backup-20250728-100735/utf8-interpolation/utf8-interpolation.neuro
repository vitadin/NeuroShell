%% UTF-8 character rendering test for variable interpolation
\set[_echo_command="true"]

%% Test basic UTF-8 interpolation
\set[cafe="cafÃ©"]
\set[japanese="æ—¥æœ¬èª"] 
\set[emoji="ğŸš€"]
\echo Basic interpolation: ${cafe}, ${japanese}, ${emoji}

%% Test nested UTF-8 interpolation - this was the main bug we fixed
\set[outer="cafÃ©"]
\set[cafÃ©="ğŸš€ rocket"]
\echo Nested UTF-8: ${${outer}}

%% Test complex nested interpolation with UTF-8
\set[prefix="utf8"]
\set[utf8_var="Testing: cafÃ© with æ—¥æœ¬èª"]
\echo Complex nested: ${${prefix}_var}

%% Test multiple levels of UTF-8 nesting
\set[level1="level2"]
\set[level2="cafÃ©_final"]
\set[cafÃ©_final="Final UTF-8: ğŸš€ âœ¨ æ—¥æœ¬èª"]
\echo Multi-level nesting: ${${${level1}}}

%% Test UTF-8 in variable names and values
\set[naÃ¯ve="rÃ©sumÃ© with ğŸŒŸ"]
\set[rÃ©sumÃ©_key="naÃ¯ve"]
\echo UTF-8 variable names: ${${rÃ©sumÃ©_key}}

%% Test interpolation with UTF-8 symbols and punctuation
\set[dash="â€”"]
\set[quotes=""Hello""]
\set[combined="${quotes} from cafÃ© ${dash} amazing"]
\echo Symbol interpolation: ${combined}

%% Test UTF-8 interpolation in complex expressions
\set[greeting="Welcome to"]
\set[place="cafÃ© naÃ¯ve"]
\set[action="serving ğŸš€ coffee"]
\echo Complex: ${greeting} ${place} â€” ${action}

%% Test UTF-8 interpolation with mathematical symbols
\set[pi="Ï€"]
\set[infinity="âˆ"]
\set[formula="Area = ${pi} Ã— rÂ² â‰  ${infinity}"]
\echo Math symbols: ${formula}

%% Test UTF-8 interpolation with currency
\set[euro="â‚¬"]
\set[yen="Â¥"]
\set[price="Coffee costs ${euro}5 or ${yen}600"]
\echo Currency: ${price}

%% Test empty and edge cases with UTF-8
\set[empty=""]
\set[cafÃ©_empty="${empty}cafÃ©${empty}"]
\echo Edge case: "${cafÃ©_empty}"

%% Test that interpolation preserves UTF-8 in edge cases
\set[special="ğŸš€${empty}cafÃ©${empty}æ—¥æœ¬èª"]
\echo Preserved UTF-8: ${special}

%% Test UTF-8 with system variables (that use numeric names)
\set[1="First: cafÃ©"]
\set[2="Second: æ—¥æœ¬èª"]
\set[3="Third: ğŸš€"]
\echo System-like variables: ${1}, ${2}, ${3}

%% Test circular reference protection with UTF-8
\set[circular_a="cafÃ© ${circular_b}"]
\set[circular_b="ğŸš€ ${circular_a}"]
\echo Circular (should stop): ${circular_a}